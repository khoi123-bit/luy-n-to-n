<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Luyện bảng nhân & bảng chia + Bài giải</title>
<style>
    body {
        background-image: url('ảnhtím.jpg');
        background-size: 75cm; 
        background-repeat: no-repeat; 
        background-position: center; 
        text-align: center;
    }
    button {
        padding:10px 20px; margin:5px; font-size:18px; cursor:pointer; border-radius:20px;
        box-shadow: rgba(210,206,206,0.8);
        position: relative; transform: translateY(0.2cm);
    }
    input { padding:5px; width:60px; font-size:16px; margin-left:10px; }
    #question { font-size:1cm; margin:20px 0; }
    .option { display:inline-block; margin:10px; border-radius:20px; }
    #progress, #timer { margin-top:10px; font-size:1cm; }
    #result h2 { margin-top:0; }
    #wordTimeInput {
        border-radius: 20px;
        transform: translateY(0.1cm);
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>
<h1>Trò chơi luyện bảng nhân & bảng chia + Bài giải</h1>

<div id="menu">
    <h2>Bảng chia</h2><div id="div-table"></div>
    <h2>Bảng nhân</h2><div id="mul-table"></div>
    <h2>Chế độ tìm x</h2>
    <button onclick="selectFindX('div')">Tìm x (Chia)</button>
    <button onclick="selectFindX('mul')">Tìm x (Nhân)</button>
    <h2>Chế độ bài giải</h2>
    <label>Thời gian (phút): <input type="number" id="wordTimeInput" value="10" min="1" max="30"></label>
    <button onclick="startWordProblem()">Làm bài giải (Word Problem)</button>
</div>

<div id="game" style="display:none;">
    <div id="question"></div>
    <div id="answers"></div>
    <div id="progress"></div>
    <div id="timer"></div>
</div>

<div id="result" style="display:none;"></div>

<script>
let mode="", table=0, score=0, questionCount=0, timerInterval, historyData=[], countdownTime=0;

function createMenuButtons(){
    const divTable=document.getElementById("div-table");
    const mulTable=document.getElementById("mul-table");
    divTable.innerHTML=""; mulTable.innerHTML="";
    for(let i=2;i<=9;i++){
        let btnDiv=document.createElement("button");
        btnDiv.textContent="Chia cho "+i;
        btnDiv.onclick=()=>startGame('div',i); divTable.appendChild(btnDiv);

        let btnMul=document.createElement("button");
        btnMul.textContent="Nhân với "+i;
        btnMul.onclick=()=>startGame('mul',i); mulTable.appendChild(btnMul);
    }
}

function startGame(selectedMode, selectedTable){
    mode=selectedMode; table=selectedTable; score=0; questionCount=0; historyData=[];
    document.getElementById("menu").style.display="none";
    document.getElementById("result").style.display="none";
    document.getElementById("game").style.display="block";
    enterFullscreen(); countdownTime=120; startCountdown(); nextQuestion();
}

function startCountdown(){
    const timerEl=document.getElementById("timer"); let remaining=countdownTime;
    timerEl.textContent=`Thời gian còn lại: ${remaining}s`;
    timerInterval=setInterval(()=>{
        remaining--; timerEl.textContent=`Thời gian còn lại: ${remaining}s`;
        if(remaining<=0){ clearInterval(timerInterval); alert("Hết giờ làm bài!");
            document.getElementById("game").style.display="none";
            document.getElementById("result").style.display="none";
            document.getElementById("menu").style.display="block";
        }
    },1000);
}
function stopTimer(){ clearInterval(timerInterval); }

function nextQuestion(){
    if(questionCount>=10){ endGame(); return; }
    questionCount++;
    let qText="", correct, a,b;

    if(mode==='div'){ b=table; correct=Math.floor(Math.random()*9)+1; a=b*correct; qText=`${a} ÷ ${b} = ?`; }
    else if(mode==='mul'){ a=table; b=Math.floor(Math.random()*9)+1; correct=a*b; qText=`${a} × ${b} = ?`; }
    else if(mode==='findx-div'){ b=Math.floor(Math.random()*8)+2; correct=Math.floor(Math.random()*9)+1; a=b*correct;
        if(Math.random()<0.5){ qText=`x ÷ ${b} = ${correct}`; correct=a; }
        else { qText=`${a} ÷ x = ${correct}`; correct=b; }
    }
    else if(mode==='findx-mul'){ a=Math.floor(Math.random()*8)+2; b=Math.floor(Math.random()*9)+1; let prod=a*b;
        if(Math.random()<0.5){ qText=`x × ${b} = ${prod}`; correct=a; }
        else { qText=`${a} × x = ${prod}`; correct=b; }
    }

    let answers=[correct];
    while(answers.length<3){ let wrong=Math.floor(Math.random()*81)+1; if(!answers.includes(wrong)) answers.push(wrong);}
    answers.sort(()=>Math.random()-0.5);

    document.getElementById("question").textContent=qText;
    let answersDiv=document.getElementById("answers"); answersDiv.innerHTML="";
    answers.forEach(ans=>{
        let btn=document.createElement("button"); btn.textContent=ans; btn.className="option answer";
        btn.onclick=()=>{ if(ans===correct) score++; historyData.push({question:qText,answer:ans,correct:correct}); nextQuestion(); };
        answersDiv.appendChild(btn);
    });
    document.getElementById("progress").textContent=`Câu ${questionCount} / 10`;
}

function endGame(){
    stopTimer(); exitFullscreen(); document.getElementById("game").style.display="none";
    let msg=`Bạn đúng ${score} / 10 câu. `; msg+=(score>=5)?"✅ Đạt":"❌ Rớt";
    document.getElementById("result").innerHTML=`
        ${msg}
        <button onclick="exportExcel()">Xuất Excel</button>
        <button onclick="createMenuButtons();document.getElementById('result').style.display='none';document.getElementById('menu').style.display='block';">Trở lại menu</button>
    `;
    document.getElementById("result").style.display="block";
}

function exportExcel(){
    let ws_data=[["Câu hỏi","Trả lời","Đáp án đúng"]];
    historyData.forEach(row=>ws_data.push([row.question,row.answer,row.correct]));
    let ws=XLSX.utils.aoa_to_sheet(ws_data);
    let wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Kết quả");
    XLSX.writeFile(wb,"ket-qua.xlsx");
}

function enterFullscreen(){ if(document.documentElement.requestFullscreen){ document.documentElement.requestFullscreen(); } }
function exitFullscreen(){ if(document.exitFullscreen){ document.exitFullscreen(); } }

document.addEventListener("fullscreenchange",()=>{
    if(!document.fullscreenElement && questionCount>0 && questionCount<10){
        stopTimer(); document.getElementById("game").style.display="none";
        document.getElementById("result").style.display="none"; document.getElementById("menu").style.display="block";
    }
});

function selectFindX(type){
    mode=type==='div'?'findx-div':'findx-mul'; table=0; score=0; questionCount=0; historyData=[];
    document.getElementById("menu").style.display="none"; document.getElementById("result").style.display="none";
    document.getElementById("game").style.display="block"; enterFullscreen(); countdownTime=150; startCountdown(); nextQuestion();
}

// Bài giải Word Problem
function startWordProblem(){
    mode='word-problem'; score=0; questionCount=0; historyData=[]; 
    let minutes = parseInt(document.getElementById("wordTimeInput").value);
    if(isNaN(minutes) || minutes<1) minutes=10;
    countdownTime = minutes*60;

    document.getElementById("menu").style.display="none";
    document.getElementById("game").style.display="block"; 
    enterFullscreen(); startCountdown();
    generateWordQuestion();
}

function generateWordQuestion(){
    if(questionCount>=10){ endGame(); return; }
    questionCount++;
    let x=Math.floor(Math.random()*50)+1; // tổ 1
    let y=Math.floor(Math.random()*50)+1; // nhiều hơn
    let qText=`Câu ${questionCount}: Tổ 1 trồng được ${x} cây, tổ 2 trồng được nhiều hơn tổ 1 là ${y} cây. Hỏi tổng số cây của hai tổ là bao nhiêu?`;
    let correct = x + (x+y);
    let answers=[correct];
    while(answers.length<3){ 
        let wrong = correct + (Math.floor(Math.random()*11)-5); 
        if(!answers.includes(wrong) && wrong>0) answers.push(wrong);
    }
    answers.sort(()=>Math.random()-0.5);
    document.getElementById("question").textContent=qText;
    let answersDiv=document.getElementById("answers"); answersDiv.innerHTML="";
    answers.forEach(ans=>{
        let btn=document.createElement("button"); btn.textContent=ans; btn.className="option answer";
        btn.onclick=()=>{ if(ans===correct) score+=2; historyData.push({question:qText,answer:ans,correct:correct}); generateWordQuestion(); };
        answersDiv.appendChild(btn);
    });
    document.getElementById("progress").textContent=`Câu ${questionCount} / 10`;
}

createMenuButtons();
</script>
</body>
</html>
